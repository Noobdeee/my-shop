<!DOCTYPE html>
<html>
<head>
  <link rel="icon" href="data:,">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Shop Herabete Admin v9.25.0</title>

<style>
body {
  margin: 0;
  font-family: 'Segoe UI', Arial, sans-serif;
  background: #f5f6fa;
}
header {
  background: #111;
  color: white;
  padding: 18px;
  text-align: center;
  font-size: 20px;
  font-weight: 600;
}
#adminBar {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0;
  background: #222;
  color: white;
  padding: 10px;
  text-align: center;
  z-index: 9999;
}
#adminBar button {
  margin-left: 10px;
  padding: 5px 12px;
  border: none;
  border-radius: 6px;
  background: red;
  color: white;
}
.grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
  padding: 20px;
}
.card {
  background: white;
  border-radius: 14px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.08);
  overflow: hidden;
  cursor: pointer;
}
.card img {
  width: 100%;
  height: 200px;
  object-fit: cover;
}
.card .name {
  font-weight: 600;
  padding: 8px;
  text-align: center;
}
.card .info { display:none; padding:12px; }
.card.show .info { display:block; }
.card input, .card textarea {
  width:100%; margin-top:6px; padding:6px;
}
#adminUnlockBtn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  padding: 14px;
  border-radius: 50%;
  border: none;
  background: #111;
  color: white;
}
</style>
</head>

<body>

<header>My Shop Heeraa-betee</header>

<div id="userSection" style="display:none;">
  <img id="userPhoto" width="35" height="35" style="border-radius:50%;">
  <span id="userName"></span>
  <button id="logoutBtn">Logout</button>
</div>

<button id="loginBtn">Login with Google</button>

<div id="adminBar">
  Admin Mode: <b>ON</b>
  <button id="adminOffBtn">OFF</button>
  <button id="addProductBtn">‚ûï Add Product</button>
</div>

<div class="grid" id="productList"></div>

<button id="adminUnlockBtn" style="display:none;">üîê Open Admin</button>

<script type="module">
/* ================= FIREBASE ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth,
  GoogleAuthProvider,
  signInWithPopup,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCV432JfpHR3abZJXPDthNvH2jDMGLRcrM",
  authDomain: "my-shop-app-dc042.firebaseapp.com",
  projectId: "my-shop-app-dc042",
  storageBucket: "my-shop-app-dc042.firebasestorage.app",
  messagingSenderId: "393287049357",
  appId: "1:393287049357:web:1460ddf82ddad440e2c2c4"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

/* ================= CONFIG ================= */
const ADMIN_UID = "mOP5jc6j28b8SIvXEyskqCtsQZG3";
const API_URL = "https://script.google.com/macros/s/AKfycbyxnxuEAgJCMA9y1y_GRkyYGg8TNbGsY3yAjRAipPVuGoocdA_XQnkIPQCbkrZOWmB5/exec";

/* ================= STATE ================= */
let adminUnlocked = false;
let products = [];

/* ================= AUTH ================= */
function googleLogin() {
  signInWithPopup(auth, provider).catch(err => alert(err.message));
}
function logoutUser() {
  signOut(auth);
}

onAuthStateChanged(auth, user => {
  adminUnlocked = false;
  adminBar.style.display = "none";
  adminUnlockBtn.style.display = "none";

  if (user) {
    userSection.style.display = "flex";
    loginBtn.style.display = "none";
    userPhoto.src = user.photoURL;
    userName.textContent = user.displayName;
    if (user.uid === ADMIN_UID) adminUnlockBtn.style.display = "block";
  } else {
    userSection.style.display = "none";
    loginBtn.style.display = "block";
  }
  loadProducts();
});

/* ================= ADMIN ================= */
async function unlockAdmin() {
  const user = auth.currentUser;
  if (!user || user.uid !== ADMIN_UID) return alert("Not authorized");

  const password = prompt("Enter Admin Password");
  if (!password) return;

  const res = await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ action: "login", password })
  });
  const data = await res.json();

  if (data.success) {
    adminUnlocked = true;
    adminBar.style.display = "block";
    adminUnlockBtn.style.display = "none";
    renderProducts();
    alert("Admin unlocked üî•");
  } else {
    alert("Wrong password ‚ùå");
  }
}
function requireAdmin() {
  if (!adminUnlocked) { alert("Unlock admin first"); return false; }
  return true;
}
function logoutAdmin() {
  adminUnlocked = false;
  adminBar.style.display = "none";
  adminUnlockBtn.style.display = "block";
  renderProducts();
}

/* ================= PRODUCTS ================= */
function loadProducts() {
  fetch(API_URL).then(r=>r.json()).then(d=>{ products=d; renderProducts(); });
}

function renderProducts() {
  productList.innerHTML = "";
  products.forEach((p,i)=>{
    const card = document.createElement("div");
    card.className="card";
    card.innerHTML = `
      <img src="${p.image||""}">
      <div class="name">${p.name||""}</div>
      <div class="info">
        ${adminUnlocked ? `
          <input id="n${i}" value="${p.name||""}">
          <textarea id="d${i}">${p.description||""}</textarea>
          <input id="p${i}" value="${p.price||""}">
          <input id="s${i}" value="${p.stock||""}">
          <button onclick="saveProduct(${i})">Save</button>
          <button onclick="deleteProduct(${i})">Delete</button>
        ` : `
          <div>${p.description||""}</div>
          <div>‚Çπ${p.price||""}</div>
          <div>Stock: ${p.stock||""}</div>
        `}
      </div>`;
    card.onclick=e=>{
      if(!e.target.closest("input,textarea,button")) card.classList.toggle("show");
    };
    productList.appendChild(card);
  });
}

window.saveProduct = async i => {
  if (!requireAdmin()) return;
  await fetch(API_URL,{method:"POST",body:JSON.stringify({
    action:"update", row:products[i].row||i+2,
    name:n[i].value, description:d[i].value,
    price:p[i].value, stock:s[i].value
  })});
  loadProducts();
};

window.deleteProduct = async i => {
  if (!requireAdmin()) return;
  if (!confirm("Delete?")) return;
  await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"delete",row:products[i].row||i+2})});
  loadProducts();
};

function addProduct(){
  if(!requireAdmin())return;
  fetch(API_URL,{method:"POST",body:JSON.stringify({action:"add"})}).then(loadProducts);
}

/* ================= EVENTS ================= */
loginBtn.addEventListener("click", googleLogin);
logoutBtn.addEventListener("click", logoutUser);
adminUnlockBtn.addEventListener("click", unlockAdmin);
adminOffBtn.addEventListener("click", logoutAdmin);
addProductBtn.addEventListener("click", addProduct);

</script>
</body>
</html>
