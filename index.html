<!DOCTYPE html>
<html>
<head>
  <link rel="icon" href="data:,">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Shop Herabete Admin v9.26.04</title>

  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f5f6fa;
    }

    header {
      background: #111;
      color: white;
      padding: 18px;
      text-align: center;
      font-size: 20px;
      font-weight: 600;
    }

    #adminBar {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #222;
      color: white;
      padding: 10px;
      text-align: center;
      z-index: 9999;
    }

    #adminBar button {
      margin-left: 10px;
      padding: 5px 12px;
      border: none;
      border-radius: 6px;
      background: red;
      color: white;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      padding: 20px;
      margin-top: 10px;
    }

    .card {
      background: white;
      border-radius: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      overflow: hidden;
      cursor: pointer;
    }

    .card img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      background: #eee;
    }

    .name {
      font-weight: 600;
      padding: 8px;
      text-align: center;
    }

    .info {
      padding: 12px;
      display: none;
    }

    .card.show .info {
      display: block;
    }

    .info input,
    .info textarea,
    .info button {
      width: 100%;
      margin-top: 6px;
      padding: 6px;
    }
  </style>
</head>

<body>

<header>My Shop Heeraa-betee</header>

<div id="userSection" style="display:none;">
  <img id="userPhoto" width="35" height="35" style="border-radius:50%;">
  <span id="userName"></span>
  <button id="logoutBtn">Logout</button>
</div>

<button id="loginBtn">Login with Google</button>

<div id="adminBar">
  Admin Mode: <b>ON</b>
  <button id="adminOffBtn">OFF</button>
  <button id="addProductBtn">‚ûï Add Product</button>
  <button id="saveOrderBtn">üíæ Save Order</button>

</div>

<button id="adminUnlockBtn" style="display:none;">üîê Open Admin</button>

<div class="grid" id="productList"></div>

<script type="module">
/* ================= FIREBASE ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth,
  GoogleAuthProvider,
  signInWithPopup,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCV432JfpHR3abZJXPDthNvH2jDMGLRcrM",
  authDomain: "my-shop-app-dc042.firebaseapp.com",
  projectId: "my-shop-app-dc042",
  storageBucket: "my-shop-app-dc042.firebasestorage.app",
  messagingSenderId: "393287049357",
  appId: "1:393287049357:web:1460ddf82ddad440e2c2c4"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

/* ================= CONFIG ================= */
const ADMIN_UID = "mOP5jc6j28b8SIvXEyskqCtsQZG3";
const API_URL = "https://script.google.com/macros/s/AKfycbyxnxuEAgJCMA9y1y_GRkyYGg8TNbGsY3yAjRAipPVuGoocdA_XQnkIPQCbkrZOWmB5/exec";

/* ================= STATE ================= */
let adminUnlocked = false;
let products = [];

/* ================= AUTH ================= */
function googleLogin() {
  signInWithPopup(auth, provider)
    .catch(err => alert(err.message));
}

function logoutUser() {
  signOut(auth);
}

onAuthStateChanged(auth, (user) => {
  adminUnlocked = false;
  document.getElementById("adminBar").style.display = "none";
  document.getElementById("adminUnlockBtn").style.display = "none";

  if (user) {
    document.getElementById("userSection").style.display = "flex";
    document.getElementById("loginBtn").style.display = "none";
    document.getElementById("userPhoto").src = user.photoURL;
    document.getElementById("userName").textContent = user.displayName;

    if (user.uid === ADMIN_UID) {
      document.getElementById("adminUnlockBtn").style.display = "block";
    }
  } else {
    document.getElementById("userSection").style.display = "none";
    document.getElementById("loginBtn").style.display = "block";
  }

  loadProducts();
});






  function saveOrder() {
  if (!requireAdmin()) return;

  const orderData = products.map((p, index) => ({
    row: p.row,
    id: p.id,
    newPosition: index + 1
  }));

  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "reorder",
      order: orderData
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert("Order saved permanently ‚úÖ");
    } else {
      alert("Failed to save order ‚ùå");
    }
  })
  .catch(err => {
    console.error("Save order error:", err);
    alert("Error saving order");
  });
}



  

/* ================= ADMIN ================= */
async function unlockAdmin() {
  const user = auth.currentUser;
  if (!user || user.uid !== ADMIN_UID) return alert("Not authorized");

  const password = prompt("Enter Admin Password");
  if (!password) return;

  const res = await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ action: "login", password })
  });

  const data = await res.json();
  if (data.success) {
    adminUnlocked = true;
    document.getElementById("adminBar").style.display = "block";
    document.getElementById("adminUnlockBtn").style.display = "none";
    renderProducts();
  } else {
    alert("Wrong password");
  }
}

function logoutAdmin() {
  adminUnlocked = false;
  document.getElementById("adminBar").style.display = "none";
  document.getElementById("adminUnlockBtn").style.display = "block";
  renderProducts();
}

function requireAdmin() {
  if (!adminUnlocked) {
    alert("Unlock admin first");
    return false;
  }
  return true;
}

/* ================= PRODUCTS ================= */
function loadProducts() {
  fetch(API_URL)
    .then(res => res.json())
    .then(data => {
      products = data;
      renderProducts();
    });
}


  
function renderProducts() {
  const list = document.getElementById("productList");
  list.innerHTML = "";

  products.forEach((p, i) => {
    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <img src="${p.image || ''}">
      <div class="name">${p.name || ''}</div>
      <div class="info">
        ${adminUnlocked ? `
          <input value="${p.name || ''}" id="name-${i}">
          <textarea id="description-${i}">${p.description || ''}</textarea>
          <input value="${p.price || ''}" id="price-${i}">
          <input value="${p.stock || ''}" id="stock-${i}">
          <button onclick="saveProduct(${i})">Save</button>
          <button onclick="deleteProduct(${i})">Delete</button>
        ` : `
          <p>${p.description || ''}</p>
          <p>‚Çπ ${p.price || ''}</p>
          <p>Stock: ${p.stock || ''}</p>
        `}
      </div>
    `;

    card.addEventListener("click", (e) => {
  if (!e.target.closest("input, textarea, button")) {
    card.classList.toggle("show");
  }
});

    list.appendChild(card);
  });
}



  
window.saveProduct = function(i) {
  if (!requireAdmin()) return;

  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "update",
      row: products[i].row,
      name: document.getElementById(`name-${i}`).value,
      description: document.getElementById(`description-${i}`).value,
      price: document.getElementById(`price-${i}`).value,
      stock: document.getElementById(`stock-${i}`).value
    })
  }).then(loadProducts);
};

window.deleteProduct = function(i) {
  if (!requireAdmin()) return;
  if (!confirm("Delete product?")) return;

  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ action: "delete", row: products[i].row })
  }).then(loadProducts);
};


document.getElementById("saveOrderBtn")
  ?.addEventListener("click", saveOrder);
  
document.getElementById("loginBtn").onclick = googleLogin;
document.getElementById("logoutBtn").onclick = logoutUser;
document.getElementById("adminUnlockBtn").onclick = unlockAdmin;
document.getElementById("adminOffBtn").onclick = logoutAdmin;
document.getElementById("addProductBtn").onclick = () => alert("Use sheet to add");
</script>

</body>
</html>
